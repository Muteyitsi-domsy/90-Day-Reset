rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function hasRequiredFields(required) {
      return request.resource.data.keys().hasAll(required);
    }

    function hasOnlyAllowedFields(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }

    function isWithinSizeLimit(bytes) {
      return request.resource.size() < bytes;
    }

    function isString(field) {
      return request.resource.data[field] is string;
    }

    function isNumber(field) {
      return request.resource.data[field] is number;
    }

    function isTimestamp(field) {
      return request.resource.data[field] is timestamp;
    }

    function stringLength(field, min, max) {
      return isString(field) &&
             request.resource.data[field].size() >= min &&
             request.resource.data[field].size() <= max;
    }

    // Users can only read/write their own data
    match /users/{userId} {
      // Read: User must be authenticated and own the document
      allow read: if isOwner(userId);

      // Create: User can create their own profile
      allow create: if isOwner(userId);

      // Update: User can update their own profile
      allow update: if isOwner(userId);

      // Delete: User can delete their own profile
      allow delete: if isOwner(userId);

      // User's journal entries subcollection
      match /journalEntries/{entryId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // User's mood journal entries subcollection
      match /moodEntries/{entryId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // User's flip journal entries subcollection
      match /flipJournalEntries/{entryId} {
        // Read: User must own the parent document
        allow read: if isOwner(userId);

        // Create: User can create their own flip entries
        allow create: if isOwner(userId);

        // Update: User can update their own flip entries
        allow update: if isOwner(userId);

        // Delete: User can delete their own entries
        allow delete: if isOwner(userId);
      }
    }

    // Audit logs collection (append-only)
    match /auditLogs/{logId} {
      // Read: Users can only read their own audit logs
      allow read: if isAuthenticated() &&
        request.auth.uid == resource.data.userId;

      // Create: Users can create audit logs for themselves
      // Logs are append-only and immutable after creation
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.userId &&
        hasRequiredFields(['userId', 'eventType', 'severity', 'timestamp', 'description', 'success']) &&
        hasOnlyAllowedFields(['userId', 'eventType', 'severity', 'timestamp', 'description', 'metadata', 'userAgent', 'deviceId', 'ipAddress', 'success', 'errorMessage']) &&
        isString('userId') &&
        isString('eventType') &&
        isString('severity') &&
        request.resource.data.severity in ['info', 'warning', 'critical'] &&
        isTimestamp('timestamp') &&
        stringLength('description', 1, 500) &&
        isWithinSizeLimit(10000); // 10KB max per audit log

      // Update and Delete: NOT ALLOWED (audit logs are immutable)
      allow update: if false;
      allow delete: if false;
    }
  }
}
